<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>
table,th,td {
  border : 1px solid black;
  border-collapse: collapse;
}
th,td {
  padding: 5px;
}
</style>
	<meta charset="utf-8">
	<link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css">  
	<script src="https://cdn.bootcss.com/jquery/2.1.1/jquery.min.js"></script>
	<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>



<script type="text/javascript">
$(document).ready(function(){
  $("#disk").change(function(){
    console.log("disk change : "+ $("#disk").val())
    setLimit($("#disk").val() * 1024,traffic_now)
    
  });

  $("#traffic").change(function(){
    console.log("traffic change : "+ $("#traffic").val())
    setLimit(disk_now * 1024,$("#traffic").val())
  });
  console.log("FogCDN Ready")
  checkPort()
  setTimeout(function(){
    loadXMLDoc()
  }, 1500)
  setTimeout(function(){
    loadLimit()
  }, 1800)
  //loadXMLDoc()
  //loadLimit()

});
</script>


</head>
<body>


<br><br>

<div class="container">
	<h2>Pear FogVDN</h2>
        <!--<button type="button" onclick="loadXMLDoc()">Refresh</button>-->
                                       
	<table class="table" id="demo1"></table>
        <br>
        <table class="table" id="demo2"></table>
</div>

<table id="demo"></table>

<form role="form">
	<div class="form-group">

<div class="container">

   <h1>Configure </h1>

   <div class="row">
      
      <div class="col-md-6" style="background-color: #dedef8;
         box-shadow: inset 1px -1px 1px #444, inset -1px 1px 1px #444;">
         <label for="name">硬盘配置(G)</label>
		<select class="form-control" id="disk">

		</select>
               
                <br><br>

		<div class="progress progress-striped">
		    <div class="progress-bar progress-bar-info" role="progressbar"
			 aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"
			 style="width: 100%;" id="disk_progress">
			<span class="sr-only">30% 完成（信息）</span>
		    </div>
		</div>
      </div>
      <div class="col-md-6" style="background-color: #dedef8;
         box-shadow: inset 1px -1px 1px #444, inset -1px 1px 1px #444;">
         <label for="name">流量配置(Mbps)</label>
		<select class="form-control" id="traffic">

		</select>
               
                <br><br>

		<div class="progress progress-striped">
		    <div class="progress-bar progress-bar-info" role="progressbar"
			 aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"
			 style="width: 100%;" id="traffic_progress">
			<span class="sr-only">30% 完成（信息）</span>
		    </div>
		</div>
      </div>
   </div><br>
   
</div>
		
	</div>
</form>




<script>
	var port = 0;
    var disk_max = 0;
    var traffic_max = 0;
    var disk_now = 0;
    var traffic_now = 0;
	function checkPort() {
      for (var i = 49193;i <= 49202; i++) {
        try {
          connectTest(i);
        } catch (e) {
        }
      }

      console.log("Port......", port)
    }

    function connectTest(testPort) {
      var xhr = new XMLHttpRequest;
      //xhr.timeout = 5500;
      xhr.open('head', "http://" + document.domain + ":" + testPort + "/method?info");
      xhr.onload = function () {
        //node.time = performance.now() - timeStart;
        // console.warn(`node.time ${node.time}`);
        if (this.status >= 200 && this.status<300) {
          console.log("status OK, testPort =", testPort);
          if(port == 0 || port > testPort)
          	port = testPort;
          console.log("and port =", port)
        }
      };
      //xhr.ontimeout = function() {
      //  console.log("timeout port", testPort)
      //};
      xhr.onerror = function() {
      };
      xhr.send();

    }

function loadXMLDoc() {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 ) {
      console.log(this);
      console.log(this.response);
      var data = '{"code": 60, "version": "366", "mac": "20:76:93:40:fc:ad", "wan": "eth0.2", "eip": "119.123.197.158", "wip": "192.168.1.2", "lip": "192.168.88.1", "nat": "Symmetric","storage_total": "2861323", "storage_avail": "2678660","upload_bw": 24.989, "download_bw": 168.923,"upload_traffic": 0, "download_traffic": 0}';
      parseJson(this.response);
    }
    console.log(this.readyState+"and status"+this.status)

  };
  xhttp.open("GET", "http://" + document.domain + ":" + port + "/method?info", true);
  xhttp.send();
}

function loadLimit() {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 ) {
      console.log(this.response);
      parseLimited(this.response)
      //parseJson(data);
    }
  };
  xhttp.open("POST", "http://" + document.domain + ":" + port + "/method?setlimited", true);
  xhttp.send();
}

// https://blog.csdn.net/kikajack/article/details/79298363
//curl -X POST http://127.0.0.1:49193/method?setlimited
//{
//    "storage_limited":100,        // 百分率
//    "bandwidth_limited":50        // 百分率
//}
function setLimit(disk,bandwidth) {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 ) {
      //if(xhr.getResponseHeader('content-type')==='application/json')
      console.log(this.response);
      loadLimit()
    }
  };
  xhttp.open("POST", "http://" + document.domain + ":" + port + "/method?setlimited", true);
  //xhttp.setRequestHeader('content-type', 'application/json'); 

  console.log(JSON.stringify({"storage_limited":parseInt(disk),"bandwidth_limited":parseInt(bandwidth)}));
  xhttp.send(JSON.stringify({"storage_limited":parseInt(disk),"bandwidth_limited":parseInt(bandwidth)}));
}





function parseLimited(myjson){
   console.log(myjson)
   var o = JSON.parse(myjson);
   console.log(o.code);
   var table1="<thead><tr><th>Name</th><th>Value</th></tr></thead><tbody>"				

  table1 += '<tr class="info"><td>' +
      'storage_limited' +
      "</td><td>" +
      o['storage_limited'] / 1024+
      "</td></tr>";

  table1 += '<tr class="info"><td>' +
    'bandwidth_limited' +
    "</td><td>" +
    o['bandwidth_limited'] +
    "</td></tr>";

  table1 +="</tbody>"	
  document.getElementById("demo2").innerHTML = table1;

  disk_now = parseInt(parseInt(o['storage_limited']) / 1024);
  traffic_now = parseInt(parseInt(o['bandwidth_limited']));
  var width1 = parseInt(parseInt(o['storage_limited']) / 1024 / disk_max * 100 );
  var width2 = parseInt(parseInt(o['bandwidth_limited']) / traffic_max * 100 );

  console.log('storage limited:', o['storage_limited'], 'bandwidth limited:', o['bandwidth_limited']);
  console.log('width1', width1, 'width2', width2);
  // document.getElementById("disk_progress").setAttribute('style', "width: " + parseInt(parseInt(o['storage_limited']) / 1024 / disk_max * 100 ).toString()+ "%;");
  // document.getElementById("traffic_progress").setAttribute('style', "width: " + parseInt(parseInt(o['bandwidth_limited']) / traffic_max * 100 ).toString()+ "%;");
  document.getElementById("disk_progress").setAttribute('style', "width: " + parseInt(parseInt(o['storage_limited']) / 1024 / 1024 * 100 ).toString()+ "%;");
  document.getElementById("traffic_progress").setAttribute('style', "width: " + parseInt(parseInt(o['bandwidth_limited']) / 32 * 100 ).toString()+ "%;");
}

function parseJson(myjson){
   console.log(myjson)
   var o = JSON.parse(myjson);

   console.log(o.code);

　　　//　console.log(p + " " +o[p]);

  //var table="<tr><th>Artist</th><th>Title</th></tr>";
  //for(var p in o){
  // table += "<tr><td>" +
  //  p +
  //  "</td><td>" +
  //  o[p] +
  //  "</td></tr>";
  //}
  //document.getElementById("demo").innerHTML = table;


var table1="<thead><tr><th>Name</th><th>Value</th></tr></thead><tbody>"

for(var p in o){
  if(p == 'wan' && (!o[p] || o[p] == "")){
    table1 += '<tr class="info"><td>' +
      p +
      "</td><td>" +
      '非路由器' +
      "</td></tr>";
  } else{
    table1 += '<tr class="info"><td>' +
      p +
      "</td><td>" +
      o[p] +
      "</td></tr>";
  }
}
  table1 +="</tbody>"	
  document.getElementById("demo1").innerHTML = table1;

  disk_max = parseInt(parseInt(o['storage_total']) / 1024);
  traffic_max = parseInt(o['upload_bw']);
  console.log('disk_max', disk_max, 'traffic_max', traffic_max);
  var level = 5;
  var disk_div = disk_max / level;
  var traffic_div = traffic_max / level;

  var disk_select = "<option disabled selected >default</option>";
  var traffic_select = "<option disabled selected >default</option>";

  disk_select += 	"<option>64</option>" +
					"<option>128</option>" +
					"<option>256</option>" +
					"<option>512</option>" +
					"<option>1024</option>";

  traffic_select += "<option>4</option>" +
    				"<option>8</option>" +
    				"<option>16</option>" +
    				"<option>32</option>";

  // for (var i = 1; i <= level; i++){
  //   disk_select += "<option>" + parseInt(i * disk_div + 1) + "</option>";
  // }
  // for (var i = 1; i < traffic_max; i *= 2){
  //   traffic_select += "<option>" + i + "</option>";
  // }
  // traffic_select += "<option>" + traffic_max + "</option>";

  document.getElementById("disk").innerHTML = disk_select;
  document.getElementById("traffic").innerHTML = traffic_select;

	
}

function myFunction(xml) {
  var i;
  var xmlDoc = xml.responseXML;
  var table="<tr><th>Artist</th><th>Title</th></tr>";
  var x = xmlDoc.getElementsByTagName("CD");
  for (i = 0; i <x.length; i++) {
    table += "<tr><td>" +
    x[i].getElementsByTagName("ARTIST")[0].childNodes[0].nodeValue +
    "</td><td>" +
    x[i].getElementsByTagName("TITLE")[0].childNodes[0].nodeValue +
    "</td></tr>";
  }
  document.getElementById("demo").innerHTML = table;
}
</script>

</body>
</html>



